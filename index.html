<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ProdSight – Production Intelligence for Faster Resolution</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel-soft:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14);
      --text:#e9eeff;
      --muted:#aab6d6;
      --accent:#6aa6ff;
      --accent-soft:rgba(106,166,255,.15);
      --radius:16px;
      --danger:#ff6a6a;
      --ok:#79ffa6;
      --warn:#ffdd6a;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, #17244a 0%, var(--bg) 55%),
        linear-gradient(180deg,#0e1530,var(--bg));
    }
    .container{max-width:1200px;margin:0 auto;padding:22px}

    .hero{
      text-align:center;
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:22px;
      padding:26px 18px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
    }
    .hero h1{margin:0;font-size:36px}
    .hero p{margin:10px 0 0;color:var(--muted);font-size:16px}
    .hero .sub{margin-top:8px;font-size:13px;color:var(--muted)}
    .mono{font-family:var(--mono)}

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:14px;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      transition:.12s ease;
      font-weight:800;
      font-size:13px;
    }
    .tab:hover{border-color:var(--accent);background:var(--accent-soft);color:var(--text)}
    .tab.active{
      border-color:var(--accent);
      background:linear-gradient(180deg,#7bb1ff,#5a90ff);
      color:#08142f;
    }

    .grid{margin-top:18px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }

    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    textarea{
      width:100%;
      background:rgba(0,0,0,.25);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      outline:none;
      min-height:180px;
      resize:vertical;
      line-height:1.5;
      font-family:var(--mono);
    }
    textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}

    .buttons{
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:14px;
      flex-wrap:wrap;
    }
    button{
      min-width:170px;
      padding:12px 18px;
      border-radius:14px;
      border:none;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(180deg,#7bb1ff,#5a90ff);
      color:#08142f;
    }
    .ghost{
      background:rgba(255,255,255,.07);
      color:var(--text);
      border:1px solid var(--border);
      font-weight:800;
    }

    .statusRow{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }

    .panel{display:none}
    .panel.active{display:block}

    .section{
      margin-top:12px;
      padding:14px;
      background:var(--panel-soft);
      border:1px solid var(--border);
      border-radius:14px;
    }
    .section h2{margin:0;font-size:18px}
    .section p{margin:8px 0 0;color:var(--muted);font-size:14px;line-height:1.45}

    .blocks{
      margin-top:14px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
    }
    @media(max-width:980px){.blocks{grid-template-columns:1fr}}

    .block{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.05);
      cursor:pointer;
      transition:.12s ease;
      min-height:140px;
    }
    .block:hover{border-color:var(--accent);background:var(--accent-soft)}
    .blockTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .blockTitle{font-weight:900}
    .badge{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .badge.ok{border-color:rgba(121,255,166,.35);background:rgba(121,255,166,.10);color:var(--ok)}
    .badge.no{border-color:rgba(255,106,106,.35);background:rgba(255,106,106,.10);color:var(--danger)}
    .badge.warn{border-color:rgba(255,221,106,.35);background:rgba(255,221,106,.12);color:var(--warn)}

    .blockBody{
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
      margin-top:8px;
      white-space:pre-wrap;
    }
    .blockFoot{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      gap:10px;
    }
    .linkish{color:var(--accent);font-weight:800}

    .pre{
      margin-top:0;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      font-family:var(--mono);
      white-space:pre-wrap;
      color:var(--text);
      font-size:12px;
      line-height:1.5;
      overflow:auto;
      max-height:60vh;
    }

    .footerInfo{
      margin-top:14px;
      padding-top:10px;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      text-align:center;
    }

    /* ProdSight Answer card (Summary) */
    .answerCard{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      background:rgba(0,0,0,.20);
    }
    .answerTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .answerTitle h3{margin:0;font-size:16px}
    .pill{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      white-space:nowrap;
    }
    .answerBody{
      font-size:13px;
      color:var(--text);
      white-space:pre-wrap;
      line-height:1.5;
    }

    /* Details layout */
    .detailGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    .detailCard{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.05);
    }
    .detailHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .detailHeader h3{margin:0;font-size:16px}
    .detailCols{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
    }
    @media(max-width:980px){.detailCols{grid-template-columns:1fr}}
    .detailCols.two{grid-template-columns:1fr 1fr}
    @media(max-width:980px){.detailCols.two{grid-template-columns:1fr}}

    .mini{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:rgba(255,255,255,.04);
      min-height:90px;
    }
    .miniTitle{font-weight:900;font-size:12px;color:var(--muted);margin-bottom:6px}
    .miniBody{
      font-size:12px;
      line-height:1.45;
      white-space:pre-wrap;
      color:var(--text);
      max-height:220px;
      overflow:auto;
      font-family:var(--mono);
    }
  </style>
</head>

<body>
<div class="container">

  <div class="hero">
    <h1>ProdSight</h1>
    <p>Production Intelligence for Faster Resolution</p>
    <div class="sub">
      <span class="mono">Proprietary solution by</span> <strong>TCS</strong>
    </div>

    <div class="tabs" role="tablist" aria-label="ProdSight Tabs">
      <div class="tab active" id="tabSummary" onclick="switchTab('summary')">Summary</div>
      <div class="tab" id="tabDetails" onclick="switchTab('details')">Details</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">

      <!-- ===================== SUMMARY PANEL ===================== -->
      <div class="panel active" id="panelSummary">

        <div class="section">
          <h2>Production Issue Analysis</h2>
          <p>
            Paste an error or log snippet. Summary shows only counts. Click any block to view details.
          </p>
        </div>

        <label>Error / Stack trace</label>
        <textarea id="inp" placeholder="Paste the production error here..."></textarea>

        <div class="buttons">
          <button onclick="runAnalyze()">Analyze</button>
          <button class="ghost" onclick="clearAll()">Clear</button>
        </div>

        <div class="statusRow">
          <span id="status">Status: Idle</span>
          <span class="mono">POST /analyze</span>
        </div>

        <!-- ProdSight Answer -->
        <div class="answerCard">
          <div class="answerTitle">
            <h3>ProdSight Answer (Gemini)</h3>
            <span class="pill" id="ansPill">Waiting…</span>
          </div>
          <div class="answerBody" id="ansBody">Run analysis to generate a structured recommendation.</div>
        </div>

        <div class="blocks">

          <!-- ServiceNow summary block (COUNT ONLY) -->
          <div class="block" id="blkSN" onclick="openDetails('servicenow')">
            <div class="blockTop">
              <div class="blockTitle">ServiceNow</div>
              <div class="badge" id="badgeSN">—</div>
            </div>
            <div class="blockBody" id="sumSN">Awaiting analysis.</div>
            <div class="blockFoot">
              <span class="mono" id="confSN"></span>
              <span class="linkish">View details →</span>
            </div>
          </div>

          <!-- Mail summary block (COUNT ONLY) -->
          <div class="block" id="blkMail" onclick="openDetails('mail')">
            <div class="blockTop">
              <div class="blockTitle">Mail</div>
              <div class="badge" id="badgeMail">—</div>
            </div>
            <div class="blockBody" id="sumMail">Awaiting analysis.</div>
            <div class="blockFoot">
              <span class="mono" id="confMail"></span>
              <span class="linkish">View details →</span>
            </div>
          </div>

          <!-- Server Logs summary block (COUNT/FOUND ONLY) -->
          <div class="block" id="blkLogs" onclick="openDetails('server_logs')">
            <div class="blockTop">
              <div class="blockTitle">Server Logs</div>
              <div class="badge" id="badgeLogs">—</div>
            </div>
            <div class="blockBody" id="sumLogs">Awaiting analysis.</div>
            <div class="blockFoot">
              <span class="mono" id="confLogs"></span>
              <span class="linkish">View details →</span>
            </div>
          </div>

        </div>

      </div>

      <!-- ===================== DETAILS PANEL ===================== -->
      <div class="panel" id="panelDetails">
        <div class="section">
          <h2>Detailed Evidence</h2>
          <p>
            ServiceNow and Mail show 3 sections each. Server Logs shows 2 sections: Log Path and Exact Error.
          </p>
        </div>

        <div class="detailGrid">

          <!-- ServiceNow details (3 sections) -->
          <div class="detailCard" id="detailSN">
            <div class="detailHeader">
              <h3>ServiceNow</h3>
              <span class="badge" id="badgeSN2">—</span>
            </div>
            <div class="detailCols">
              <div class="mini">
                <div class="miniTitle">INC Numbers</div>
                <div class="miniBody" id="snIncList">Run analysis.</div>
              </div>
              <div class="mini">
                <div class="miniTitle">Error (last time)</div>
                <div class="miniBody" id="snErrList">Run analysis.</div>
              </div>
              <div class="mini">
                <div class="miniTitle">Resolution (last time)</div>
                <div class="miniBody" id="snResList">Run analysis.</div>
              </div>
            </div>
          </div>

          <!-- Mail details (3 sections) -->
          <div class="detailCard" id="detailMail">
            <div class="detailHeader">
              <h3>Mail</h3>
              <span class="badge" id="badgeMail2">—</span>
            </div>
            <div class="detailCols">
              <div class="mini">
                <div class="miniTitle">Subjects</div>
                <div class="miniBody" id="mailSubjList">Run analysis.</div>
              </div>
              <div class="mini">
                <div class="miniTitle">Error (last time)</div>
                <div class="miniBody" id="mailErrList">Run analysis.</div>
              </div>
              <div class="mini">
                <div class="miniTitle">Resolution (summary)</div>
                <div class="miniBody" id="mailResList">Run analysis.</div>
              </div>
            </div>
          </div>

          <!-- Server Logs details (2 sections) -->
          <div class="detailCard" id="detailLogs">
            <div class="detailHeader">
              <h3>Server Logs</h3>
              <span class="badge" id="badgeLogs2">—</span>
            </div>
            <div class="detailCols two">
              <div class="mini">
                <div class="miniTitle">Log Path</div>
                <div class="miniBody" id="logPathBox">Run analysis.</div>
              </div>
              <div class="mini">
                <div class="miniTitle">Exact Error</div>
                <div class="miniBody" id="logErrBox">Run analysis.</div>
              </div>
            </div>
          </div>

          <!-- Raw JSON (optional, for debug) -->
          <div class="detailCard">
            <div class="detailHeader">
              <h3>Raw Payload (Debug)</h3>
              <span class="pill">Optional</span>
            </div>
            <pre id="detailsOut" class="pre">Run analysis to view payload.</pre>
          </div>

        </div>

        <div class="buttons">
          <button class="ghost" onclick="switchTab('summary')">Back to Summary</button>
        </div>
      </div>

      <div class="footerInfo">
        <strong>ProdSight</strong> — Production Intelligence for Faster Resolution<br/>
        Proprietary solution by <strong>TCS</strong>
      </div>

    </div>
  </div>
</div>

<script>
  // ===================== CONFIG =====================
  // Replace with your Render backend URL:
  // Example: https://prodsight-backend.onrender.com
  const API_BASE = "https://YOUR-RENDER-BACKEND.onrender.com";
  const ANALYZE_URL = API_BASE + "/analyze";

  // ===================== STATE =====================
  let lastPayload = null;

  // ===================== TABS =====================
  function switchTab(which){
    document.getElementById("tabSummary").classList.toggle("active", which==="summary");
    document.getElementById("tabDetails").classList.toggle("active", which==="details");
    document.getElementById("panelSummary").classList.toggle("active", which==="summary");
    document.getElementById("panelDetails").classList.toggle("active", which==="details");
  }

  function openDetails(which){
    switchTab("details");
    // Scroll to relevant section for nice UX
    const map = {
      servicenow: "detailSN",
      mail: "detailMail",
      server_logs: "detailLogs"
    };
    const id = map[which] || "detailSN";
    setTimeout(() => {
      const el = document.getElementById(id);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    }, 50);
  }

  // ===================== UI HELPERS =====================
  function setBadge(el, found){
    el.classList.remove("ok","no");
    if(found){
      el.classList.add("ok");
      el.textContent = "Found";
    } else {
      el.classList.add("no");
      el.textContent = "Not Found";
    }
  }

  function fmtConf(x){
    if(x === null || x === undefined || x === "") return "";
    const n = Number(x);
    if(Number.isNaN(n)) return "";
    return "confidence=" + n.toFixed(3);
  }

  function asList(lines, max=8){
    if(!lines || !lines.length) return "Not Found";
    return lines.slice(0,max).map((x,i)=>`${i+1}) ${x}`).join("\n");
  }

  // Supports:
  // A) NEW: details.servicenow.matches[]
  // B) OLD: details.servicenow single object
  function getServiceNowMatches(details){
    const sn = (details && details.servicenow) || {};
    if(Array.isArray(sn.matches)) return sn.matches;
    if(sn && (sn.incident_id || sn.error_signature || sn.root_cause)) return [sn];
    return [];
  }

  // Supports:
  // A) NEW: details.mail.matches[]
  // B) OLD: details.mail.alert/resolution
  function getMailMatches(details){
    const m = (details && details.mail) || {};
    if(Array.isArray(m.matches)) return m.matches;

    if(m.alert || m.resolution){
      const alert = m.alert || {};
      const resolution = m.resolution || {};
      const subject = resolution.subject || alert.subject || "";
      const thread_id = resolution.thread_id || alert.thread_id || "";
      const err = (alert.body || "").split("\n").slice(0,2).join(" ").trim();
      const res = (resolution.body || "").split("\n").slice(0,6).join(" ").trim();
      return [{
        subject,
        thread_id,
        error_snippets: err ? [err] : [],
        resolution_snippets: res ? [res] : []
      }];
    }
    return [];
  }

  function renderSummaryCounts(payload){
    const details = payload.details || {};

    // ServiceNow count
    const snMatches = getServiceNowMatches(details);
    const snCount = snMatches.length;
    document.getElementById("sumSN").textContent =
      snCount ? `Total matching incidents: ${snCount}` : "Total matching incidents: 0";

    // Mail count
    const mailMatches = getMailMatches(details);
    const mailCount = mailMatches.length;
    document.getElementById("sumMail").textContent =
      mailCount ? `Total matching threads: ${mailCount}` : "Total matching threads: 0";

    // Logs one-liner
    const lg = payload.server_logs || {};
    const found = !!lg.found;
    document.getElementById("sumLogs").textContent =
      found ? "Server log reference found. (Click to view details)" : "No server log reference found.";
  }

  function renderDetailsServiceNow(payload){
    const details = payload.details || {};
    const matches = getServiceNowMatches(details);

    const incs = matches.map(m => m.incident_id).filter(Boolean);
    document.getElementById("snIncList").textContent = incs.length ? incs.join(", ") : "Not Found";

    const errs = matches.map(m => (m.error_signature || m.root_cause || "")).filter(Boolean);
    document.getElementById("snErrList").textContent = asList(errs.map(x => String(x).slice(0,240)), 8);

    const res = [];
    for(const m of matches){
      const arr = m.resolution || m.resolution_steps || [];
      if(Array.isArray(arr)) arr.forEach(r => r && res.push(String(r)));
    }
    const uniq = [...new Set(res)];
    document.getElementById("snResList").textContent = asList(uniq.map(x => x.slice(0,280)), 10);
  }

  function renderDetailsMail(payload){
    const details = payload.details || {};
    const matches = getMailMatches(details);

    const subjects = matches.map(m => m.subject).filter(Boolean);
    document.getElementById("mailSubjList").textContent = subjects.length ? asList(subjects, 10) : "Not Found";

    const errs = [];
    const ress = [];
    for(const m of matches){
      (m.error_snippets || []).forEach(x => x && errs.push(String(x)));
      (m.resolution_snippets || []).forEach(x => x && ress.push(String(x)));
    }
    document.getElementById("mailErrList").textContent = asList(errs.map(x => x.slice(0,280)), 10);
    document.getElementById("mailResList").textContent = asList(ress.map(x => x.slice(0,280)), 12);
  }

  function renderDetailsLogs(payload){
    const lg = payload.server_logs || {};
    const details = payload.details || {};
    const logs = details.server_logs || {};

    // Log path box (from details.server_logs.log_path if available; else summary)
    const logPath = logs.log_path || (lg.summary || "");
    document.getElementById("logPathBox").textContent = logPath ? String(logPath) : "Not Found";

    // Exact error box: show the pasted input error (source-of-truth for “exact error”)
    const exact = (document.getElementById("inp").value || "").trim();
    document.getElementById("logErrBox").textContent = exact ? exact : "Not Provided";
  }

  function renderBadges(payload){
    const sn = payload.servicenow || {};
    const ml = payload.mail || {};
    const lg = payload.server_logs || {};

    setBadge(document.getElementById("badgeSN"), !!sn.found);
    setBadge(document.getElementById("badgeMail"), !!ml.found);
    setBadge(document.getElementById("badgeLogs"), !!lg.found);

    setBadge(document.getElementById("badgeSN2"), !!sn.found);
    setBadge(document.getElementById("badgeMail2"), !!ml.found);
    setBadge(document.getElementById("badgeLogs2"), !!lg.found);

    document.getElementById("confSN").textContent = fmtConf(sn.confidence);
    document.getElementById("confMail").textContent = fmtConf(ml.confidence);
    document.getElementById("confLogs").textContent = fmtConf(lg.confidence);
  }

  function renderAnswer(payload){
    const ans = (payload && payload.prodsight_answer) ? String(payload.prodsight_answer) : "";
    document.getElementById("ansBody").textContent = ans || "No LLM answer returned.";
    document.getElementById("ansPill").textContent = ans ? "Generated" : "Missing";
  }

  function renderRaw(payload){
    document.getElementById("detailsOut").textContent = JSON.stringify(payload, null, 2);
  }

  function renderAll(payload){
    lastPayload = payload;
    renderBadges(payload);
    renderAnswer(payload);
    renderSummaryCounts(payload);

    // Details tab content
    renderDetailsServiceNow(payload);
    renderDetailsMail(payload);
    renderDetailsLogs(payload);
    renderRaw(payload);
  }

  // ===================== MAIN ACTION =====================
  async function runAnalyze(){
    const status = document.getElementById("status");
    const text = (document.getElementById("inp").value || "").trim();
    if(!text){
      status.textContent = "Status: Please paste an error first.";
      return;
    }

    status.textContent = "Status: Analyzing…";

    try{
      const r = await fetch(ANALYZE_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ error_text: text })
      });

      if(!r.ok){
        const t = await r.text();
        throw new Error(t || ("HTTP " + r.status));
      }

      const data = await r.json();
      renderAll(data);
      status.textContent = "Status: Done";
    }catch(e){
      status.textContent = "Status: Error";
      document.getElementById("ansPill").textContent = "Error";
      document.getElementById("ansBody").textContent = String(e && e.message ? e.message : e);
      document.getElementById("detailsOut").textContent = String(e && e.message ? e.message : e);
    }
  }

  function clearAll(){
    document.getElementById("inp").value = "";
    document.getElementById("status").textContent = "Status: Idle";

    document.getElementById("badgeSN").textContent = "—";
    document.getElementById("badgeMail").textContent = "—";
    document.getElementById("badgeLogs").textContent = "—";
    document.getElementById("badgeSN2").textContent = "—";
    document.getElementById("badgeMail2").textContent = "—";
    document.getElementById("badgeLogs2").textContent = "—";

    document.getElementById("sumSN").textContent = "Awaiting analysis.";
    document.getElementById("sumMail").textContent = "Awaiting analysis.";
    document.getElementById("sumLogs").textContent = "Awaiting analysis.";

    document.getElementById("confSN").textContent = "";
    document.getElementById("confMail").textContent = "";
    document.getElementById("confLogs").textContent = "";

    document.getElementById("ansPill").textContent = "Waiting…";
    document.getElementById("ansBody").textContent = "Run analysis to generate a structured recommendation.";

    document.getElementById("snIncList").textContent = "Run analysis.";
    document.getElementById("snErrList").textContent = "Run analysis.";
    document.getElementById("snResList").textContent = "Run analysis.";

    document.getElementById("mailSubjList").textContent = "Run analysis.";
    document.getElementById("mailErrList").textContent = "Run analysis.";
    document.getElementById("mailResList").textContent = "Run analysis.";

    document.getElementById("logPathBox").textContent = "Run analysis.";
    document.getElementById("logErrBox").textContent = "Run analysis.";

    document.getElementById("detailsOut").textContent = "Run analysis to view payload.";
    lastPayload = null;

    switchTab("summary");
  }
</script>
</body>
</html>
